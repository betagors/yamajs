# yaml-language-server: $schema=../../packages/cli/src/yama.schema.json
project:
  name: blog-api
  version: 1.0.0

plugins:
  - "@betagors/yama-pglite"

# ============================================================================
# SCHEMAS: Data definitions
# ============================================================================
schemas:
  # Database entities
  Author:
    database: authors
    fields:
      id: uuid!
      name: string!
      email: string! unique
      bio: text?
      createdAt: timestamp = now
      updatedAt: timestamp = now

  Post:
    database:
      table: posts
      indexes:
        - fields: [authorId, publishedAt]
        - fields: [published]
    fields:
      id: uuid!
      title: string! indexed
      content: text!
      excerpt: string?
      published: boolean = false
      publishedAt: timestamp?
      author: Author! cascade
      createdAt: timestamp = now
      updatedAt: timestamp = now

  Comment:
    database:
      table: comments
      indexes:
        - fields: [postId]
        - fields: [postId, authorEmail]
          unique: true
    fields:
      id: uuid!
      content: text!
      authorName: string!
      authorEmail: string!
      post: Post! cascade
      createdAt: timestamp = now
      updatedAt: timestamp = now

  # API schemas (views/DTOs)
  PostSummary:
    source: Post
    fields:
      id: uuid!
      title: string!
      excerpt: string?
      published: boolean!
      authorName: string!
    computed:
      authorName: "{{author.name}}"

  PostDetail:
    source: Post
    fields:
      id: uuid!
      title: string!
      content: string!
      excerpt: string?
      published: boolean!
      publishedAt: timestamp?
      author: Author!
      createdAt: timestamp!
      updatedAt: timestamp!

  AuthorWithPosts:
    source: Author
    fields:
      id: uuid!
      name: string!
      email: string!
      bio: string?
      posts: PostSummary[]

# ============================================================================
# OPERATIONS: Business logic definitions
# ============================================================================
operations:
  # Posts - Standard CRUD
  listPosts: PostSummary[]
  getPost: PostDetail
  createPost: Post
  updatePost: Post
  deletePost: ~

  # Posts - Custom operations
  searchPosts:
    input:
      q: string!
      published: boolean?
      limit: number = 20
      offset: number = 0
    output: PostSummary[]

  listPublishedPosts:
    output: PostSummary[]
    filter:
      published: true

  publishPost:
    input:
      id: uuid!
    output: Post
    handler: src/handlers/publishPost.ts

  unpublishPost:
    input:
      id: uuid!
    output: Post
    handler: src/handlers/unpublishPost.ts

  # Authors
  listAuthors: Author[]
  getAuthor: AuthorWithPosts
  createAuthor: Author
  updateAuthor: Author

  # Comments - Nested under Post
  listComments:
    parent: Post
    output: Comment[]

  getComment:
    parent: Post
    output: Comment

  createComment:
    parent: Post
    input:
      content: string!
      authorName: string!
      authorEmail: string!
    output: Comment

  deleteComment:
    parent: Post
    output: ~

  # Author posts (nested)
  listAuthorPosts:
    parent: Author
    output: PostSummary[]

# ============================================================================
# POLICIES: Reusable access control
# ============================================================================
policies:
  public:
    auth: false

  authenticated:
    auth: true

  author:
    auth:
      required: true
      roles: [author, admin]

  admin:
    auth:
      required: true
      roles: [admin]

# ============================================================================
# APIS: Expose operations
# ============================================================================
apis:
  rest:
    public:
      basePath: /api/v1
      defaultPolicy: public
      operations:
        # Public read operations
        - listPosts
        - getPost
        - searchPosts
        - listPublishedPosts
        - listAuthors
        - getAuthor
        - listComments
        - getComment
        - listAuthorPosts
        
        # Protected write operations
        - createPost: author
        - updatePost: author
        - publishPost: author
        - unpublishPost: author
        - createComment: authenticated
        - createAuthor: admin
        
      # Exclude from public API
      exclude:
        - deletePost
        - deleteComment

    admin:
      basePath: /api/admin
      defaultPolicy: admin
      operations:
        - all

# ============================================================================
# RATE LIMITS
# ============================================================================
rateLimits:
  default:
    window: 15m
    max: 100
  operations:
    createPost:
      window: 1h
      max: 10
    createComment:
      window: 1h
      max: 20

# ============================================================================
# CACHE
# ============================================================================
cache:
  default:
    ttl: 5m
  operations:
    listPosts:
      ttl: 1m
      invalidateOn: [createPost, updatePost, deletePost, publishPost]
    getPost:
      ttl: 5m
      key: "post:{id}"
      invalidateOn: [updatePost, deletePost, publishPost]
    listPublishedPosts:
      ttl: 2m
      invalidateOn: [publishPost, unpublishPost]

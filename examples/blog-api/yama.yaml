# yaml-language-server: $schema=../../packages/cli/src/yama.schema.json
project:
  name: blog-api
  version: 1.0.0

plugins:
  - "@betagors/yama-pglite"

schemas:
  Author:
    database:
      table: authors
    crud:
      enabled: false
    fields:
      id: uuid!
      name: string!
      email: string! unique  # Inline constraint: unique
      bio: text?
      createdAt: timestamp = now
      updatedAt: timestamp = now

  Post:
    database:
      table: posts
      indexes:
        - fields: [authorId, publishedAt]  # authorId auto-generated from inline relation
        - fields: [published]
    crud:
      enabled: false
    fields:
      id: uuid!
      title: string! indexed
      content: text!
      excerpt: string?
      published: boolean = false
      publishedAt: timestamp?
      # Inline relation - auto-generates authorId: uuid!
      author: Author! cascade
      createdAt: timestamp = now
      updatedAt: timestamp = now

  Comment:
    database:
      table: comments
      indexes:
        - fields: [postId]  # postId auto-generated from inline relation
    crud:
      enabled: false
    fields:
      id: uuid!
      content: text!
      authorName: string!
      authorEmail: string!
      # Inline relation - auto-generates postId: uuid!
      post: Post! cascade
      createdAt: timestamp = now
      updatedAt: timestamp = now

  PostWithAuthor:
    fields:
      id: uuid!
      title: string!
      content: string!
      excerpt: string!
      published: boolean!
      publishedAt: string?
      author: Author!
      createdAt: string!
      updatedAt: string!

  DeleteResponse:
    fields:
      success: boolean!

apis:
  rest:
    default:
      basePath: /api/v1
      endpoints:
        - method: GET
          path: /posts
          response: PostWithAuthor[]
          query:
            published: boolean?
            authorId: uuid?
            limit: number = 10
            offset: number = 0
          handler: src/handlers/listPosts.ts

        - method: POST
          path: /posts
          response: Post
          body: Post
          handler: src/handlers/createPost.ts

        - method: GET
          path: /posts/{id}
          response: PostWithAuthor
          params:
            id: uuid!
          handler: src/handlers/getPost.ts

        - method: PUT
          path: /posts/{id}
          response: Post
          body: Post
          params:
            id: uuid!
          handler: src/handlers/updatePost.ts

        - method: DELETE
          path: /posts/{id}
          response: DeleteResponse
          params:
            id: uuid!
          handler: src/handlers/deletePost.ts

        - method: POST
          path: /posts/{id}/publish
          response: Post
          params:
            id: uuid!
          handler: src/handlers/publishPost.ts

        - method: GET
          path: /posts/{id}/comments
          response: Comment[]
          params:
            id: uuid!
          handler: src/handlers/getPostComments.ts

        - method: POST
          path: /posts/{id}/comments
          response: Comment
          body:
            fields:
              content: string!
              authorName: string!
              authorEmail: string!
          params:
            id: uuid!
          handler: src/handlers/createComment.ts

        - method: GET
          path: /authors
          response: Author[]
          handler: src/handlers/listAuthors.ts

        - method: POST
          path: /authors
          response: Author
          body: Author
          handler: src/handlers/createAuthor.ts

        - method: GET
          path: /authors/{id}
          response: Author
          params:
            id: uuid!
          handler: src/handlers/getAuthor.ts

        - method: GET
          path: /authors/{id}/posts
          response: Post[]
          params:
            id: uuid!
          handler: src/handlers/getAuthorPosts.ts
